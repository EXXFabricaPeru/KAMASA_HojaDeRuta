<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8' />
  <title>Get started with the Map Matching API</title>
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <!-- Import Mapbox GL JS  -->
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css' rel='stylesheet' />
  <!-- Import jQuery -->
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css' type='text/css' />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
	
body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      #instructions {
        position: absolute;
        margin: 20px;
        width: 25%;
        top: 0;
        bottom: 20%;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.9);
        overflow-y: scroll;
        font-family: sans-serif;
        font-size: 0.8em;
        line-height: 2em;
      }
      .duration {
        font-size: 2em;
      }
	  
	  .rounded-rect {
	background: white;
	border-radius: 10px;
	box-shadow: 0 0 50px -25px black;
	}
	 
	.flex-center {
	position: absolute;
	display: flex;
	justify-content: center;
	align-items: center;
	}
	 
	.flex-center.left {
	left: -10px;
	}
	 
	.flex-center.right {
	right: 0px;
	}
	 
	.sidebar-content {
	position: absolute;
	width: 95%;
	height: 95%;
	font-family: Arial, Helvetica, sans-serif;
	font-size: 15px;
	color: gray;
	}
	 
	.sidebar-toggle {
	position: absolute;
	width: 1.3em;
	height: 1.3em;
	overflow: visible;
	display: flex;
	justify-content: center;
	align-items: center;
	}
	 
	.sidebar-toggle.left {
	right: -1.5em;
	}
	 
	.sidebar-toggle.right {
	left: -1.5em;
	}
	 
	.sidebar-toggle:hover {
	color: #0aa1cf;
	cursor: pointer;
	}
	 
	.sidebar {
	transition: transform 1s;
	z-index: 1;
	width: 400px;
	height: 100%;
	}
	 
	/*
	The sidebar styling has them "expanded" by default, we use CSS transforms to push them offscreen
	The toggleSidebar() function removes this class from the element in order to expand it.
	*/
	.left.collapsed {
	transform: translateX(-380px);
	}
	 
	.right.collapsed {
	transform: translateX(295px);
	}
    
  </style>
</head>

<body>
  <!-- Create a container for the map -->
  <div id='map'>
  <div id="left" class="sidebar flex-center left collapsed">
	<div class="sidebar-content rounded-rect flex-center">
	<table>
	<thead>
	<tr>
		<th>
		CODIGO
		</th>
		<th>
		ZONA
		</th>
		<th>
		COLOR
		</th>
		<th>
		KILOS
		</th>

	</tr>
	
	</thead>
	<tbody id="tbdatosrutas" name="tbdatosrutas">
	
		
	
	</tbody>
	</table>
	<div style="font-size: 36px;" class="sidebar-toggle rounded-rect left" onclick="toggleSidebar('left')">
	&rarr;
	</div>
	</div>
	</div>
  </div>

  <script>
    
	function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
    results = regex.exec(window.location.href);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

var prodId = getParameterByName('coordenadas');
	var decodebase64 = atob(prodId);
	console.log(decodebase64);
      // Add your Mapbox access token
      mapboxgl.accessToken = 'pk.eyJ1IjoiZmVsaXhzb2xhbm8iLCJhIjoiY2tveXQ0ZXdyMGR2bzJ3cWlwOHVxOWVkZyJ9.DFX9vGxv28Wb7Z7BxRg0Zg';
      var map = new mapboxgl.Map({
        container: 'map', // Specify the container ID
        style: 'mapbox://styles/mapbox/streets-v11', // Specify which map style to use
        center: [-122.42442402062166, 37.799655040161724], // Specify the starting position
        zoom: 14.5 // Specify the starting zoom
      });

      var draw = new MapboxDraw({
        // Instead of showing all the draw tools, show only the line string and delete tools
        displayControlsDefault: false,
        controls: {
          line_string: false,
          trash: false
        },
        styles: [
          // Set the line style for the user-input coordinates
          {
            'id': 'gl-draw-line',
            'type': 'line',
            'filter': [
              'all',
              ['==', '$type', 'LineString'],
              ['!=', 'mode', 'static']
            ],
            'layout': {
              'line-cap': 'round',
              'line-join': 'round'
            },
            'paint': {
              'line-color': '#438EE4',
              'line-dasharray': [0.2, 2],
              'line-width': 2,
              'line-opacity': 0.7
            }
          },
          // Style the vertex point halos
          {
            'id': 'gl-draw-polygon-and-line-vertex-halo-active',
            'type': 'circle',
            'filter': [
              'all',
              ['==', 'meta', 'vertex'],
              ['==', '$type', 'Point'],
              ['!=', 'mode', 'static']
            ],
            'paint': {
              'circle-radius': 12,
              'circle-color': '#FFF'
            }
          },
          // Style the vertex points
          {
            'id': 'gl-draw-polygon-and-line-vertex-active',
            'type': 'circle',
            'filter': [
              'all',
              ['==', 'meta', 'vertex'],
              ['==', '$type', 'Point'],
              ['!=', 'mode', 'static']
            ],
            'paint': {
              'circle-radius': 8,
              'circle-color': '#438EE4'
            }
          }
        ]
      });

      // Add the draw tool to the map
      //map.addControl(draw);

      // Add create, update, or delete actions
      //map.on('draw.create', updateRoute);
      //map.on('draw.update', updateRoute);
      //map.on('draw.delete', removeRoute);

      // Use the coordinates you just drew to make the Map Matching API request
      function updateRoute(index,color,coordenada) {
        removeRoute(index); // Overwrite any existing layers
		console.log("Update");
        var profile = 'driving'; // Set the profile

        // Get the coordinates
        //var data = draw.getAll();
		//console.log(data);
        //var lastFeature = data.features.length - 1;
        //var coords = data.features[lastFeature].geometry.coordinates;
        // Format the coordinates
		var coords =coordenada;
        var newCoords = coords.join(';');
        // Set the radius for each coordinate pair to 25 meters
        var radius = [];
		console.log(coords);
        coords.forEach((element) => {
          radius.push(25);
        });
		
		
		
		
        getMatch(index,color,newCoords, radius, profile);
      }
	function toggleSidebar(id) {
		var elem = document.getElementById(id);
		var classes = elem.className.split(' ');
		var collapsed = classes.indexOf('collapsed') !== -1;
		 
		var padding = {};
		 
		if (collapsed) {
		// Remove the 'collapsed' class from the class list of the element, this sets it back to the expanded state.
		classes.splice(classes.indexOf('collapsed'), 1);
		 
		padding[id] = 300; // In px, matches the width of the sidebars set in .sidebar CSS class
		map.easeTo({
		padding: padding,
		duration: 1000 // In ms, CSS transition duration property for the sidebar matches this value
		});
		} else {
		padding[id] = 0;
		// Add the 'collapsed' class to the class list of the element
		classes.push('collapsed');
		 
		map.easeTo({
		padding: padding,
		duration: 1000
		});
		}
		 
		// Update the class list on the element
		elem.className = classes.join(' ');
	}
      // Make a Map Matching request
      function getMatch(index,color,coordinates, radius, profile) {
        // Separate the radiuses with semicolons
        var radiuses = radius.join(';');
        // Create the query
        var query =
          'https://api.mapbox.com/matching/v5/mapbox/' +
          profile +
          '/' +
          coordinates +
          '?geometries=geojson&radiuses=' +
          radiuses +
          '&steps=true&access_token=' +
          mapboxgl.accessToken;

        $.ajax({
          method: 'GET',
          url: query
        }).done(function (data) {
		console.log(data);
          var coords = data.matchings[0].geometry;
          // Draw the route on the map
          addRoute(index,color,coords);
          //getInstructions(data.matchings[0]);
        });
      }

      function getInstructions(data) {
        // Target the sidebar to add the instructions
        var directions = document.getElementById('directions');

        var legs = data.legs;
        var tripDirections = [];
        // Output the instructions for each step of each leg in the response object
        for (var i = 0; i < legs.length; i++) {
          var steps = legs[i].steps;
          for (var j = 0; j < steps.length; j++) {
            tripDirections.push('<br><li>' + steps[j].maneuver.instruction) +
              '</li>';
          }
        }
        directions.innerHTML =
          '<br><h2>Trip duration: ' +
          Math.floor(data.duration / 60) +
          ' min.</h2>' +
          tripDirections;
      }

      // Draw the Map Matching route as a new layer on the map
      function addRoute(index,color,coords) {
        // If a route is already loaded, remove it
        if (map.getSource('route'+index)) {
          map.removeLayer('route'+index);
          map.removeSource('route'+index);
        } else {
		console.log(index);
		console.log(coords);
          map.addLayer({
            'id': 'route'+index,
            'type': 'line',
            'source': {
              'type': 'geojson',
              'data': {
                'type': 'Feature',
                'properties': {},
                'geometry': coords
              }
            },
            'layout': {
              'line-join': 'round',
              'line-cap': 'round'
            },
            'paint': {
              'line-color': color,
              'line-width': 8,
              'line-opacity': 0.8
            }
          });
        }
      }

      // If the user clicks the delete draw button, remove the layer if it exists
      function removeRoute(index) {
        if (map.getSource('route'+index)) {
		console.log("route");
          map.removeLayer('route'+index);
          map.removeSource('route'+index);
        } else {
          return;
        }
      }
    
	map.on('load', function () {
	map.addControl(new mapboxgl.NavigationControl());
        toggleSidebar('left');
		//console.log(JSON.parse(JSON.stringify(decodebase64)));	
		//console.log("1");	
		var arraydata = JSON.parse(decodebase64);
	
		//var arregloDatos = JSON.parse(arraydata);
		//console.log(arraydata);	
		var count = 0;
				
				
		$.each(arraydata, function (index, item) {
			//console.log(item["position"]);
			
			var arraypoins= [];
			var countpoints = 0;
			$.each(item["positiones"],function(indexp, itemp){
				var arraycoord=[itemp["longitude"],itemp["latitude"]];
				//console.log(arraycoord);
				var popup = new mapboxgl.Popup().setText(countpoints).addTo(map);
				var marker = new mapboxgl.Marker({ color: item["CodeColor"]}).setLngLat(arraycoord).addTo(map).setPopup(popup);
				countpoints++;
				arraypoins.push(arraycoord);
			
			});
			
			console.log(arraypoins);
			updateRoute(count,item["CodeColor"],arraypoins);
			//console.log(item["CodeColor"]);
			//var arraycoorini=[item["positionini"]["longitude"],item["positionini"]["latitude"]];
			//var arraycoofin=[item["positionfin"]["longitude"],item["positionfin"]["latitude"]];
			// fnPuntoIni(count,arraycoorini,item["CodeColor"]);
			////console.log(item["positionfin"]["latitude"]); 
			//
			//fnpaintdestino(count,arraycoorini,item["CodeColor"]);
			//
			//fnPuntoFin(count,arraycoorini,arraycoofin,item["CodeColor"]);
			//fnpaintdestino(count, ,item["CodeColor"]);
			//fnpaintdestino(count,arraycoorini,item["CodeColor"]);
			//fnpaintdestino(count,arraycoorini,item["CodeColor"]);
			//fnPuntoFin(count,arraycoorini,arraycoofin,item["CodeColor"]);
			//fnPuntoFin(count,arraycoorini,arraycoofin,item["CodeColor"]);
			//fnPuntoFin(count,arraycoorini,arraycoofin,item["CodeColor"]);
			count++;
			
			var html ="<tr>";
			html +="<td>"+item["codruta"]+"</td>";
			html +="<td>"+item["zona"]+"</td>";
			html +="<td>"+item["NombreColor"]+"</td>";
			html +="<td>"+item["kilos"]+"</td>";
			html +="</tr>";
			
			$("#tbdatosrutas").append(html);
        });
		
		

      });

	
	
	
  </script>
</body>

</html>